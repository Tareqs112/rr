# توثيق الأخطاء والمشاكل البرمجية في نظام تأجير السيارات

سأقوم بتوثيق جميع الأخطاء والمشاكل البرمجية التي أكتشفها في النظام، مع تصنيفها حسب نوع المشكلة وموقعها في الكود. سيتم تحديث هذا الملف باستمرار أثناء عملية التحليل.

## منهجية التحليل

سأتبع منهجية منظمة لتحليل الكود واكتشاف الأخطاء، بدءاً من الملفات الأساسية في الخلفية (Backend) ثم الواجهة الأمامية (Frontend)، مع التركيز على المشاكل التالية:

- أخطاء في هيكلية قاعدة البيانات
- مشاكل في العلاقات بين الجداول
- أخطاء في التحقق من المدخلات والتعامل مع الأخطاء
- مشاكل في الأمان والتوثيق
- أخطاء في المنطق البرمجي للعمليات الأساسية
- مشاكل في واجهة المستخدم وتجربة المستخدم
- قضايا الأداء والكفاءة

## الأخطاء المكتشفة

### 1. مشاكل في نموذج العملاء (Customer Model)

في ملف `backend/models/Customer.js`، لاحظت أن العلاقة بين العملاء والشركات غير مصممة بشكل صحيح. حالياً، يتم تخزين اسم الشركة كحقل نصي بسيط (company_name) في جدول العملاء، بدلاً من إنشاء علاقة هيكلية واضحة بين العملاء والشركات. هذا يمنع إمكانية:

- ربط عدة عملاء بنفس الشركة بشكل منظم
- إدارة بيانات الشركات بشكل مركزي
- استخراج تقارير وإحصائيات على مستوى الشركة
- تنزيل حسابات العملاء المرتبطين بشركة معينة

يجب إنشاء نموذج منفصل للشركات (Company) وربطه بنموذج العملاء من خلال علاقة مناسبة، مما يسمح بتنظيم العملاء تحت الشركات وإدارة حساباتهم بشكل جماعي.

### 2. غياب نظام حساب الرصيد المستحق للعملاء

لا يوجد في النظام الحالي آلية لحساب وتتبع الرصيد المستحق لكل عميل. في ملف `backend/controllers/bookingController.js`، يتم تسجيل حالة الدفع (payment_status) للحجوزات، لكن لا توجد وظيفة لحساب إجمالي المبالغ المستحقة لكل عميل أو تتبع المدفوعات والمتبقي.

هذا يجعل من الصعب:
- معرفة المبلغ الإجمالي المستحق على كل عميل
- تتبع تاريخ المدفوعات والمتأخرات
- إنشاء تقارير مالية دقيقة

### 3. عدم وجود نظام فواتير (Vouchers) منفصل لكل عميل

النظام الحالي لا يدعم إنشاء وإدارة فواتير منفصلة لكل عميل. في ملف `backend/controllers/bookingController.js`، يتم تسجيل معلومات الحجز والدفع، لكن لا توجد وظيفة لإنشاء فواتير رسمية يمكن تنزيلها أو إرسالها للعملاء.

هذا يؤثر على:
- توثيق المعاملات المالية بشكل رسمي
- تقديم إيصالات وفواتير للعملاء
- الامتثال للمتطلبات المحاسبية والضريبية

### 4. مشاكل في التحقق من المدخلات في وحدة الحجوزات

في ملف `backend/controllers/bookingController.js`، هناك بعض المشاكل في التحقق من المدخلات:

- في دالة `createBooking`، لا يوجد تحقق من صحة التواريخ والأوقات المدخلة
- لا يوجد تحقق من أن تاريخ الإرجاع يأتي بعد تاريخ الاستلام
- في دالة `updateBooking`، هناك تعقيد غير ضروري في التحقق من توفر المركبة

هذه المشاكل قد تؤدي إلى حجوزات غير صالحة أو تعارضات في الجدول الزمني.

### 5. مشكلة في إدارة حالة المركبات

في ملف `backend/controllers/bookingController.js`، عند إنشاء حجز جديد، يتم تغيير حالة المركبة إلى "booked" مباشرة، بغض النظر عن تاريخ الحجز. هذا يعني أن المركبة ستظهر كمحجوزة حتى لو كان الحجز في المستقبل البعيد، مما يمنع استخدامها في حجوزات أخرى في الفترات المتاحة.

يجب تعديل هذا السلوك بحيث تظل المركبة متاحة حتى موعد الاستلام الفعلي، مع وجود نظام لتتبع الحجوزات المستقبلية.

### 6. مشاكل في نظام الإشعارات

في ملف `backend/controllers/bookingController.js`، هناك محاولة لإنشاء إشعارات للعملاء قبل موعد الاستلام، لكن التنفيذ غير مكتمل:

- يتم إنشاء سجل للإشعار في قاعدة البيانات، لكن لا توجد آلية فعلية لإرسال الإشعار في الوقت المحدد
- التعليق يشير إلى أن هذا "سيتم التعامل معه بواسطة جدولة في بيئة الإنتاج"، لكن لا يوجد تنفيذ لهذه الجدولة

هذا يعني أن نظام الإشعارات غير فعال حالياً ولن يتلقى العملاء إشعارات فعلية.

### 7. عدم وجود تعامل مع الأخطاء بشكل مناسب

في العديد من الملفات مثل `backend/controllers/customerController.js` و `backend/controllers/bookingController.js`، يتم التقاط الأخطاء باستخدام try/catch، لكن التعامل مع الأخطاء يقتصر على طباعة رسالة الخطأ في وحدة التحكم وإرسال رسالة عامة "Server error" للمستخدم.

هذا النهج:
- لا يوفر معلومات كافية للمستخدم عن سبب الخطأ
- يصعب تتبع وتصحيح الأخطاء في بيئة الإنتاج
- لا يميز بين أنواع الأخطاء المختلفة (مثل أخطاء التحقق من الصحة، أخطاء قاعدة البيانات، إلخ)

سأواصل تحديث هذا الملف مع اكتشاف المزيد من المشاكل أثناء تحليل باقي الكود.
